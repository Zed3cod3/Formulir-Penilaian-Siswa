<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Penilaian Siswa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [KEEP ALL YOUR EXISTING CSS STYLES] */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #3498db, #8e44ad);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        /* [KEEP ALL YOUR EXISTING CSS STYLES - SAME AS BEFORE] */
        
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingIndicator" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner"></i>
            <p>Menyimpan data, harap tunggu...</p>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo">
                    <img src="img/spenduga.jpg" alt="Logo SMP Negeri 23 Balikpapan">
                </div>
            </div>
            
            <h1>Form Penilaian Siswa</h1>
            <p class="description">Formulir penilaian perkembangan siswa SMP Negeri 23 Balikpapan</p>
        </div>
        
        <!-- Notifikasi -->
        <div id="successMessage" class="notification success">
            <i class="fas fa-check-circle"></i> <span id="successText">Penilaian berhasil disimpan!</span>
        </div>
        
        <div id="errorMessage" class="notification error">
            <i class="fas fa-exclamation-circle"></i> <span id="errorText">Terjadi kesalahan!</span>
        </div>
        
        <form id="evaluationForm">
            <!-- [KEEP ALL YOUR EXISTING FORM FIELDS] -->
            <!-- Data Siswa -->
            <div class="section">
                <h2 class="section-title"><i class="fas fa-user-graduate"></i> Data Siswa</h2>
                <div class="form-group">
                    <label for="nama">Nama Siswa: <span class="required">*</span></label>
                    <input type="text" id="nama" name="nama" required>
                </div>
                <div class="form-group">
                    <label for="kelas">Kelas: <span class="required">*</span></label>
                    <select id="kelas" name="kelas" required>
                        <option value="">Pilih Kelas</option>
                        <optgroup label="Kelas VII">
                            <option value="VII-A">VII-A</option>
                            <option value="VII-B">VII-B</option>
                            <option value="VII-C">VII-C</option>
                            <option value="VII-D">VII-D</option>
                            <option value="VII-E">VII-E</option>
                            <option value="VII-F">VII-F</option>
                        </optgroup>
                        <optgroup label="Kelas VIII">
                            <option value="VIII-A">VIII-A</option>
                            <option value="VIII-B">VIII-B</option>
                            <option value="VIII-C">VIII-C</option>
                            <option value="VIII-D">VIII-D</option>
                            <option value="VIII-E">VIII-E</option>
                            <option value="VIII-F">VIII-F</option>
                        </optgroup>
                        <optgroup label="Kelas IX">
                            <option value="IX-A">IX-A</option>
                            <option value="IX-B">IX-B</option>
                            <option value="IX-C">IX-C</option>
                            <option value="IX-D">IX-D</option>
                            <option value="IX-E">IX-E</option>
                            <option value="IX-F">IX-F</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label for="semester">Semester: <span class="required">*</span></label>
                    <select id="semester" name="semester" required>
                        <option value="">Pilih Semester</option>
                        <option value="1">Semester Ganjil</option>
                        <option value="2">Semester Genap</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tahunAjaran">Tahun Ajaran: <span class="required">*</span></label>
                     <select id="tahunAjaran" name="tahunAjaran" required>
                        <option value="">Pilih Tahun Ajaran</option>
                        <option value="2024/2025">2024/2025</option>
                        <option value="2025/2026">2025/2026</option>
                    </select>
                </div>
            </div>
            
            <!-- [KEEP ALL OTHER SECTIONS - SAME AS BEFORE] -->
            
            <div class="btn-container">
                <button type="submit" id="submitButton"><i class="fas fa-save"></i> Simpan Penilaian</button>
            </div>
        </form>
    </div>

    <script>
        // ⚠️ GANTI DENGAN URL WEB APP ANDA ⚠️
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhMWvFyzNGc_6CDu6pGP3Smq82uhcq4ppot4Dgavu1aobXGqo0h4hAQZa8qa9UTHtk/exec";
        
        document.getElementById('evaluationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log("Form submission started");
            
            // Sembunyikan pesan sebelumnya
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Validasi sederhana
            const requiredFields = this.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                    field.style.borderColor = '#e74c3c';
                } else {
                    field.style.borderColor = '#ddd';
                }
            });
            
            // Validasi khusus untuk nilai rata-rata
            const nilaiInput = document.getElementById('nilai');
            const nilai = parseFloat(nilaiInput.value);
            
            if (isNaN(nilai) || nilai < 0 || nilai > 100) {
                isValid = false;
                nilaiInput.style.borderColor = '#e74c3c';
                showError('Nilai rata-rata harus berupa angka antara 0 dan 100!');
                return;
            }
            
            if (!isValid) {
                showError('Harap lengkapi semua field yang wajib diisi dengan benar!');
                return;
            }
            
            // Kumpulkan data form
            const formData = new FormData(this);
            const data = {};
            
            // Proses data ekstrakurikuler
            const ekstraChecked = document.querySelectorAll('input[name="ekstrakurikuler"]:checked');
            const ekstrakurikuler = [];
            
            ekstraChecked.forEach(checkbox => {
                ekstrakurikuler.push(checkbox.value);
            });
            
            // Tambahkan data ke objek
            for (let [key, value] of formData.entries()) {
                if (key === 'ekstrakurikuler') {
                    continue;
                }
                data[key] = value;
            }
            
            // Tambahkan data ekstrakurikuler (dipisahkan koma)
            data.ekstrakurikuler = ekstrakurikuler.join(', ');
            
            console.log("Data to be sent:", data);
            
            // Tampilkan loading indicator di tengah halaman
            document.getElementById('loadingIndicator').style.display = 'flex';
            document.getElementById('submitButton').disabled = true;
            
            try {
                // Kirim data ke Google Apps Script
                console.log("Sending data to:", SCRIPT_URL);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                console.log("Response status:", response.status);
                console.log("Response headers:", response.headers);
                
                // PERBAIKAN: Handle empty response
                const responseText = await response.text();
                console.log("Raw response:", responseText);
                
                if (!responseText) {
                    throw new Error('Empty response from server');
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error('Invalid JSON response from server: ' + responseText);
                }
                
                console.log("Parsed response data:", result);
                
                if (result.result === "success") {
                    showSuccess('Penilaian berhasil disimpan! Data tersimpan di spreadsheet.');
                    
                    // Reset form
                    this.reset();
                    
                    // Scroll ke atas
                    window.scrollTo(0, 0);
                    
                } else {
                    throw new Error(result.message || "Unknown error from server");
                }
            } catch (error) {
                console.error('Error details:', error);
                showError('Terjadi kesalahan saat menyimpan data: ' + error.message);
            } finally {
                // Sembunyikan loading indicator
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('submitButton').disabled = false;
            }
        });
        
        // Fungsi untuk menampilkan pesan sukses
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            document.getElementById('successText').textContent = message;
            successElement.style.display = 'block';
            
            // Auto hide success message after 5 seconds
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }
        
        // Fungsi untuk menampilkan pesan error
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorElement.style.display = 'block';
        }
        
        // Test koneksi saat halaman dimuat
        window.addEventListener('load', async function() {
            try {
                console.log("Testing connection to:", SCRIPT_URL);
                const response = await fetch(SCRIPT_URL);
                const responseText = await response.text();
                console.log("Connection test response:", responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse test response:", e);
                    return;
                }
                
                console.log("Backend connection test:", result);
            } catch (error) {
                console.error("Backend connection failed:", error);
            }
        });
    </script>
</body>
</html>
